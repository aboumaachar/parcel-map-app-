name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Cache frontend node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            frontend-node-modules-
      - name: Install & build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run test -- --watchAll=false --runInBand || true
          npm run build
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build

  backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Cache backend node modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-node-modules-${{ matrix.node-version }}-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            backend-node-modules-${{ matrix.node-version }}-
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci
      - name: Run backend unit tests with coverage
        working-directory: backend
        run: npm test -- --coverage --collectCoverageFrom='server.js,kmzProcessor.js,notify.js' || true
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  e2e:
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-tests]
    env:
      PLAYWRIGHT_REPORT_PATH: playwright-report.json
    steps:
      - uses: actions/checkout@v4
      - name: Ensure docker-compose available
        run: docker-compose --version
      - name: Start services (PostGIS, Redis, GeoServer, Backend, Worker, Frontend)
        run: |
          docker-compose -f docker-compose.yml up -d --build postgis redis geoserver backend worker frontend
          # wait for PostGIS to be ready
          for i in {1..30}; do docker-compose exec -T postgis pg_isready -U parcel_user && break || sleep 2; done
          # wait for Redis to be ready
          for i in {1..20}; do docker-compose exec -T redis redis-cli ping | grep PONG && break || sleep 1; done
      - name: Wait for backend health
        run: |
          for i in {1..20}; do curl -sSf http://localhost:3001/api/health && break || sleep 2; done
      - name: Install frontend deps (for Playwright)
        working-directory: frontend
        run: |
          npm ci
          npx playwright install --with-deps
      - name: Run Playwright E2E tests
        working-directory: frontend
        run: npx playwright test --config=../playwright.config.js --reporter=list --timeout=120000 || true
        continue-on-error: false
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            frontend/playwright-report.json
            frontend/test-results
            frontend/playwright/videos
            frontend/playwright/screenshots
      - name: Teardown
        if: always()
        run: docker-compose -f docker-compose.yml down -v
